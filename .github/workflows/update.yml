on: [workflow_dispatch, push]

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
         ref: ${{ github.head_ref }}
      - run: npm i node-fetch showdown
      - uses: actions/github-script@v4
        id: step
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fetch = require("node-fetch");
            const fs = require("fs")
            const showdown = require("showdown");
            let r = await fetch("https://api.github.com/users/explosion-scratch/events").then((res) => res.json());
            r = r
              .map((i) => {
                if (i.type === "PushEvent") {
                  return `- [\`${i.payload.commits[0].sha}\`](https://github.com/${i.repo.name}/commit/${i.payload.commits[0].sha})â€“ ${i.payload.commits[0].message} ([${i.repo.name}](https://github.com/${i.repo.name}))`;
                }
                if (i.type === "IssueCommentEvent" && i.payload.action === "created") {
                  return `- Commented in [${i.repo.name}](${
                    i.payload.comment.html_url
                  })<blockquote>${clip(i.payload.comment.body)}</blockquote>`;
                }
                if (i.type === "PullRequestEvent") {
                  let act;
                  if (i.payload.pull_request.merged_by) {
                    act =
                      i.payload.pull_request.merged_by.login === "Explosion-Scratch" &&
                      i.payload.pull_request.merged_at.slice(0, 16) ===
                        i.created_at.slice(0, 16)
                        ? "Merged"
                        : i.payload.action;
                  } else {
                    act = i.payload.action;
                  }
                  return `- ${act} a [pull request](${i.payload.pull_request.html_url}) in [${i.repo.name}](https://github.com/${i.repo.name})`;
                }
              })
              .join("\n");
            var converter = new showdown.Converter();
            let out =  converter.makeHtml(r);
            fs.writeFileSync('./test.md', out);
            return out;
            function clip(str, length = 150){
              let e = str.slice(0, length);
              e += e.length == length ? "..." : "";
              return e.replace(/<(.|\n)*?>/g, "").replace(/\W+/g, " ");
            }
          result-encoding: string
      - name: Get result
        run: cat start.md echo "${{steps.step.outputs.result}}" > README.md
      - uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "YEET DID IT WORK?!?!!"
